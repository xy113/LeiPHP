{template header}
<div class="top">
    <div class="area">
        <h3 class="h3">申请遇到问题，拨打客服电话:0858-8772117</h3>
        <h1 class="h1">申请开店 > 填写店铺信息</h1>
    </div>
</div>

<div class="area store-form-div">
    <div class="form-content">
        <form method="post" id="shopForm" action="{U:('m=openshop&c=shop&a=save')}">
            <input type="hidden" name="formsubmit" value="yes">
            <input type="hidden" name="formhash" value="{FORMHASH}">
            <div class="form-group">
                <div class="lable-name">店铺名称:</div>
                <div class="label-input">
                    <input type="text" class="input-text" name="shop[shop_name]" id="shop_name" maxlength="40" placeholder="请输入店铺名称">
                    <div class="err-tips" id="err_name"></div>
                </div>
            </div>

            <div class="form-group">
                <div class="lable-name">手机号码:</div>
                <div class="label-input">
                    <input type="text" class="input-text" name="shop[phone]" id="phone" maxlength="40" placeholder="请输入负责人手机号码">
                    <div class="err-tips" id="err_phone"></div>
                </div>
            </div>

            <div class="form-group">
                <div class="lable-name">所在城市:</div>
                <div class="label-input">
                    <select class="input-select select" id="province" name="shop[province]">
                        <option value="">请选择</option>
                    </select>
                    <select class="input-select select" id="city" name="shop[city]">
                        <option value="">请选择</option>
                    </select>
                    <select class="input-select select" id="county" name="shop[county]">
                        <option value="">请选择</option>
                    </select>
                    <div class="err-tips" id="err_location"></div>
                </div>
            </div>

            <div class="form-group">
                <div class="lable-name">详细地址:</div>
                <div class="label-input">
                    <input type="text" class="input-text" name="shop[street]" id="street" placeholder="请输入街道地址，如：金水港湾">
                    <span class="ui-button button-location" id="button-location">去定位</span>
                    <p>可以拖动蓝色图标到你的店铺所在位置</p>
                    <div class="err-tips" id="err_street"></div>
                </div>
            </div>

            <div class="form-group">
                <div class="lable-name"></div>
                <div class="label-input">
                    <input type="hidden" name="shop[lng]" id="longitude" value="0">
                    <input type="hidden" name="shop[lat]" id="latitude" value="0">
                    <div class="map-hd"><div class="map" id="map"></div></div>
                </div>
            </div>

            <div class="form-group">
                <div class="lable-name">门店LOGO:</div>
                <div class="label-input">
                    <div class="pic-item">
                        <div class="pic-demo">
                            <img src="/static/images/common/ex-logo.png">
                            <span class="t">示例</span>
                        </div>
                        <div class="pic-uploader">
                            <div class="t">点击上传</div>
                            <div class="pic" id="pic_preview_1">
                                <div class="b"></div>
                                <div class="t">重新上传</div>
                            </div>
                            <input type="file" class="file" accept="image/*" id="file_1" name="filedata">
                            <input type="hidden" name="shop[shop_logo]" id="shop_logo" value="">
                        </div>
                        <div class="pic-tips">上传与店铺气质吻合的Logo，能提高用户进店的概率<br>支持JPG/JPEG/PNG格式图片，文件大小不超过500K</div>
                    </div>
                    <div class="err-tips" id="err_logo"></div>
                </div>
            </div>
            <div class="form-group">
                <div class="lable-name">营业执照编号:</div>
                <div class="label-input">
                    <input type="text" class="input-text" name="shop_info[license_no]" id="license_no" maxlength="40" placeholder="营业执照编号">
                    <div class="err-tips" id="err_license_no"></div>
                </div>
            </div>
            <div class="form-group">
                <div class="lable-name">营业执照照片:</div>
                <div class="label-input">
                    <div class="pic-item">
                        <div class="pic-demo">
                            <img src="/static/images/common/ex-front.png">
                            <span class="t">示例</span>
                        </div>
                        <div class="pic-uploader">
                            <div class="t">点击上传</div>
                            <div class="pic" id="pic_preview_2">
                                <div class="b"></div>
                                <div class="t">重新上传</div>
                            </div>
                            <input type="file" class="file" accept="image/*" id="file_2" name="filedata">
                            <input type="hidden" name="shop_info[license_pic]" id="license_pic" value="">
                        </div>
                        <div class="pic-tips">一张真实美观的门脸照可以提升店铺形象<br>支持JPG/JPEG/PNG格式图片，文件大小不超过5MB</div>
                    </div>
                    <div class="err-tips" id="err_pic_front"></div>
                </div>
            </div>

            <div class="form-group">
                <div class="lable-name">其他证件照片:</div>
                <div class="label-input">
                    <div class="pic-item">
                        <div class="pic-demo">
                            <img src="/static/images/common/ex-shop.png">
                            <span class="t">示例</span>
                        </div>
                        <div class="pic-uploader">
                            <div class="t">点击上传</div>
                            <div class="pic" id="pic_preview_3">
                                <div class="b"></div>
                                <div class="t">重新上传</div>
                            </div>
                            <input type="file" class="file" accept="image/*" id="file_3" name="filedata">
                            <input type="hidden" name="shop_info[other_card_pic]" id="other_card_pic" value="">
                        </div>
                        <div class="pic-tips">简洁干净的店内照可以让用户放心点单<br>支持JPG/JPEG/PNG格式图片，文件大小不超过5MB</div>
                    </div>
                    <div class="err-tips" id="err_pic_inside"></div>
                </div>
            </div>

            <div class="button-div">
                <input type="button" class="ui-button button" id="prev-step" value="上一步">　
                <input type="submit" class="ui-button button" value="提交创建店铺">
            </div>
        </form>
    </div>
</div>
<script src="http://webapi.amap.com/maps?v=1.3&key={$_G[setting][amap_key]}" type="text/javascript"></script>
<script src="/static/js/dsxmap.js" type="text/javascript"></script>
<script type="text/javascript">
$(function () {
    var mapObj = new DSXMap('map', {zoom:13});
    var marker = mapObj.createMarker({draggable:true});
    mapObj.addMarker(marker);
    mapObj.setCurrentLocation(function (data) {
        mapObj.map.setCenter(data.position);
        marker.setPosition(data.position);
        setLocation(data.position);
        AMap.event.addListener(marker,'dragend',function (e) {
            var position = e.target.getPosition();
            setLocation(position);
        });
        AMap.event.addListener(marker,'mousemove',function (e) {
            var position = e.target.getPosition();
            setLocation(position);
        });
    }, function (err) {
        //alert(JSON.stringify(err));
    });
    function setLocation(position) {
        $("#longitude").val(position.getLng());
        $("#latitude").val(position.getLat());
    }

    var district = new DistrictSelector({
        province:'贵州省',
        city:'六盘水市',
        county:'水城县'
    });
    $("#button-location").on('click', function (e) {
        var provice = $("#province").val();
        if (!provice) {
            DSXUI.error('请选择省份');
            return false;
        }
        var city = $("#city").val();
        if (!city) {
            DSXUI.error('请选择城市');
            return false;
        }
        var county = $("#county").val();
        if (!county) {
            DSXUI.error('请选择区县');
            return false;
        }
        var street = $.trim($("#street").val());
        if (!street) {
            DSXUI.error('请填写街道地址');
            return false;
        }
        var  address = provice+city+county+street;
        mapObj.geocoder(address, function (data) {
            //alert(JSON.stringify(data));
            var position = data[0].location
            mapObj.map.setCenter(position);
            marker.setPosition(position);
            setLocation(position);
        }, function (status, result) {
            //alert(JSON.stringify(result));
        });
    });

    var spinner = null;
    $("#file_1").AjaxFileUpload({
        action:"{U:('m=jsapi&c=material&a=uploadimg')}",
        onSubmit:function () {
            spinner = DSXUI.showSpinner();
        },
        onComplete:function (filename, response) {
            setTimeout(function () {
                spinner.close();
                if (response.errcode == 0){
                    $("#pic_preview_1").css({'background-image':'url('+response.data.thumburl+')'}).show();
                    $("#shop_logo").val(response.data.image);
                }else {
                    DSXUI.error('上传失败');
                }
            },500);
        }
    });

    $("#file_2").AjaxFileUpload({
        action:"{U:('m=jsapi&c=material&a=uploadimg')}",
        onSubmit:function () {
            spinner = DSXUI.showSpinner();
        },
        onComplete:function (filename, response) {
            setTimeout(function () {
                spinner.close();
                if (response.errcode == 0){
                    $("#pic_preview_2").css({'background-image':'url('+response.data.thumburl+')'}).show();
                    $("#license_pic").val(response.data.image);
                }else {
                    DSXUI.error('上传失败');
                }
            },500);
        }
    });

    $("#file_3").AjaxFileUpload({
        action:"{U:('m=jsapi&c=material&a=uploadimg')}",
        onSubmit:function () {
            spinner = DSXUI.showSpinner();
        },
        onComplete:function (filename, response) {
            setTimeout(function () {
                spinner.close();
                if (response.errcode == 0){
                    $("#pic_preview_3").css({'background-image':'url('+response.data.thumburl+')'}).show();
                    $("#other_card_pic").val(response.data.image);
                }else {
                    DSXUI.error('上传失败');
                }
            },500);
        }
    });

    var hasSubmited = false;
    function checkSubmit() {
        if (hasSubmited) return;
        var shop_name = $.trim($("#shop_name").val());
        if (!shop_name) {
            DSXUI.error('请填写店铺名称');
            return false;
        }
        var phone = $.trim($("#phone").val());
        if (!phone) {
            DSXUI.error('请填写手机号码');
            return false;
        }
        var province = $("#province").val();
        var city = $("#city").val();
        var county = $("#county").val();
        var street = $.trim($("#street").val());
        if (!province || !city || !county || !street){
            DSXUI.error('请填写店铺所在位置');
            return false;
        }
        var lng = $("#longitude").val();
        var lat = $("#latitude").val();
        if (!lng || !lat){
            DSXUI.error('请在地图中选择店铺所在位置');
            return false;
        }

        var shop_logo = $("#shop_logo").val();
        if (!shop_logo) {
            DSXUI.error('请上传店铺LOGO');
            return false;
        }
        var license_no = $.trim($("#license_no").val());
        if (!license_no){
            DSXUI.error('请填写营业执照编号');
            return false;
        }

        var license_pic = $("#license_pic").val();
        if (!license_pic){
            DSXUI.error('请上传营业执照照片');
            return false;
        }
        hasSubmited = true;
    }
    $("#shopForm").on('submit', checkSubmit);
    $("#prev-step").on('click', function () {
        history.go(-1);
    });
});
</script>
{template footer_common}